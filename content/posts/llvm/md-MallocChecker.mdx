---
title: "LLVM MallocChecker"
date: "2025-12-29"
summary: "Clang Static Analyzer - MallocCheckeranalyze"
tags: ["llvm", "Static Analyzer", "MallocChecker"]
draft: false
---
LLVM / Clang Static Analyzer 의 핵심 구성 요소 중 하나이다.
이 파일은 C/C++ 프로그램에서 발생할 수 있는 동적 메모리 관리 오류를 탐지하는 로직을 담고 있음.

1) 개요 및 목적
- MallocChecker는 이름과 달리 malloc / free 뿐만 아니라 C++의 new / delete, 각종 OS 커널 함수, 사용자 정의 메모리 할당 함수까지 모두 다룸.
- 주요 탐지 오류는 아래와 같음
  - Leak(메모리 누수) : 할당된 메모리가 해제되지 않고 포인터가 소멸됨
  - Double Free (이중 해제) : 이미 해제된 메모리를 다시 해제함
  - Use-After-Free (UAF, 해제 후 사용) : 해제된 메모리 영역에 접근함
  - Mismatched Deallocator : malloc으로 할당하고 delete 로 해제하는 등의 부적절한 쌍 사용
  - Tainted Allocation : 외부 입력값 (Tainted data)을 검증 없이 할당 크기로 사용함.

2) 핵심 데이터 구조
- AllocationFamily
메모리가 어떤 계열로 할당되었는지 정의함. 
이를 통해 할당-해제 쌍이 맞는지 검사함.
  - AF_Malloc: malloc, free 계열.
  - AF_CXXNew/AF_CXXNewArray: C++ new, delete 계열.
  - AF_Alloca: 스택 할당(alloca). 해제하면 안 됨.
  - AF_Custom: __attribute((ownership_returns(malloc))) 등 사용자 정의 속성.

- RefState (메모리의 상태)
분석기는 각 메모리 심볼(SymbolRef)의 상태를 추적합니다.
  - Allocated: 메모리가 성공적으로 할당됨.
  - Released: 메모리가 해제됨.
  - Escaped: 포인터가 분석 범위를 벗어남 (다른 함수로 전달 등). 더 이상 추적하지 않음.
  - Relinquished: 소유권이 이전됨 (스마트 포인터 등).

3) 주요 동작 메커니즘
- evalCall: 함수 호출 모델링
분석기가 malloc이나 free 같은 함수 호출을 만났을 때 실제 코드를 실행하는 대신, 추상적으로 메모리 상태를 변경함.
  - AllocatingMemFnMap 등에 등록된 함수(malloc, calloc 등)를 만나면 새로운 심볼을 생성하고 상태를 Allocated로 바꿈.
  - FreeingMemFnMap에 등록된 함수(free, g_free 등)를 만나면 FreeMemAux를 호출하여 해제 로직을 수행함.

- checkDeadSymbols: 누수(Leak) 탐지
  - 분석이 진행되면서 특정 포인터 변수가 더 이상 사용되지 않게 될 때(DeadSymbols), 해당 심볼이 여전히 Allocated 상태라면 Memory Leak으로 보고함.

- ReallocMemAux: realloc의 복잡성 처리
  - realloc은 성공 시 기존 메모리 해제 + 새 메모리 할당, 실패 시 기존 메모리 유지라는 복잡한 경로를 가짐.
  - 코드는 이 두 가지 경로(Path)를 모두 시뮬레이션하여 잠재적인 오류를 찾음.

4) 특이 사항 및 고급 기능
- 스마트 포인터 대응 (handleSmartPointerRelatedCalls)
  - 최신 C++ 코드에서는 std::unique_ptr 등을 사용함. 
  - 분석기는 포인터가 스마트 포인터 생성자에 전달되면 이를 Escaped 또는 **Relinquished**로 처리하여, 스마트 포인터가 대신 관리하게 되었음을 인식하고 가짜 누수 보고(False Positive)를 방지함.

- 커널 메모리 모델링 (performKernelMalloc)
  - Linux나 BSD 커널에서 사용하는 kmalloc이나 M_ZERO 플래그를 인식함. 
  - 특정 플래그가 설정된 경우 메모리가 0으로 초기화된 것으로 간주(calloc처럼 동작)함.

- 오염 분석 (checkTaintedness)
  - 사용자로부터 입력받은 값이 할당 크기(size)로 들어올 경우, 매우 큰 값이 입력되어 정수 오버플로나 서비스 거부(DoS) 공격으로 이어질 수 있음을 경고함.

=====================================================================

요약해 보자면 이 파일은 상태 머신(State Machine) 기반의 분석 엔진임. 
포인터의 생애 주기(`할당 → 사용 → 해제`)를 추적하며 각 단계에서 정의된 규칙(ex: "해제된 상태에서 사용 금지")을 위반하는지 감시합니다.
